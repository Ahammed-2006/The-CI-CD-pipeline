pipeline {
    agent any

    environment {
        DOCKER_CREDENTIALS = 'docker-hub-cred-id' // Replace with your Jenkins Docker Hub credentials ID
        DOCKER_IMAGE = 'ahammed2006/shopping:latest'
        APP_HOME = '/app'
    }

    stages {
        stage('Checkout') {
            steps {
                git branch: 'main', url: 'https://github.com/your-repo/shopping-cart.git'
            }
        }

        stage('Build Maven') {
            steps {
                echo "Building Maven project..."
                // Skip tests temporarily so Docker build can proceed
                sh 'mvn clean package -DskipTests'
            }
        }

        stage('Build Docker Image') {
            steps {
                echo "Building Docker image..."
                sh "docker build -t shopping:latest -f docker/Dockerfile ."
            }
        }

        stage('Tag and Push Docker Image') {
            steps {
                echo "Tagging and pushing Docker image..."
                withDockerRegistry([credentialsId: env.DOCKER_CREDENTIALS, url: 'https://index.docker.io/v1/']) {
                    sh "docker tag shopping:latest ${env.DOCKER_IMAGE}"
                    sh "docker push ${env.DOCKER_IMAGE}"
                }
            }
        }
    }

    post {
        success {
            echo "Pipeline completed successfully! Docker image pushed: ${env.DOCKER_IMAGE}"
        }
        failure {
            echo "Pipeline failed. Check logs for details."
        }
    }
}
